<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../t-text-container/travel-element-styles.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="t-activity-single-avail-api.html">
<link rel="import" href="../t-behavior/t-page-behavior.html">
<link rel="import" href="../t-behavior/t-activity-page-behavior.html">
<link rel="import" href="t-activity-option-item.html">
<link rel="import" href="t-activity-more-info.html">
<link rel="import" href="t-activity-summary.html">
<!--
A comment describing this element

Example:

    <t-activity-option-list-page></t-activity-option-list-page>

Example:

    <t-activity-option-list-page>
      <h2>Hello t-activity-option-list-page</h2>
    </t-activity-option-list-page>

@demo demo/index.html
-->
<dom-module id="t-activity-option-list-page">

    <template>
        <style include="iron-flex"></style>
        <style include="iron-flex-alignment"></style>
        <style include="travel-element-styles">
            :host {
                display: block;
                font-family: var(--header-font-family, --primary-font-family);
                font-size: var(--font-14, 14px);
            }
            .options {
                font-size: var(--font-18, 18px);
            }
            .list-item-half {
                width:50%;
                box-sizing:border-box;
                -webkit-box-sizing:border-box;
                -moz-box-sizing:border-box;
            }
        </style>

        <content></content>

        <t-image-carousel
            light-box
            loading-icon="maps:hotel"
            zoomed="{{imgzoomed}}"
            data="[[itinerary.photoUrls]]" 
            height="200">
        </t-image-carousel>

        <template is="dom-if" if="[[itinerary.description]]">
            <t-activity-summary
                description="[[itinerary.description]]">                    
            </t-activity-summary>
        </template>

        <div class="section-small">
            <div class="layout horizontal">
                <div class="font-bold options self-center">
                    Options
                </div>
            </div>
        </div>

        <template id="list" is="dom-repeat" items="[[itinerary.options]]">
            <t-activity-option-item 
                option=[[item]]
                on-option-selected="_onOptionSelect">
            </t-activity-option-item>
        </template>

        <t-activity-more-info
            additional-text="[[itinerary.additionalText]]"
            legal-text="[[itinerary.legalText]]"
            schedule="[[itinerary.schedule]]">                
        </t-activity-more-info>

        <t-activity-single-avail-api
            id="singleAvailApi" 
            loading={{loading}} 
            api-base-url="[[apiBaseUrl]]"
            api-relative-url="api/activity/results/single" 
            auth-token="[[authToken]]"
            on-t-activity-single-avail-api-success="_onSingleAvailSuccess"
            on-t-activity-single-avail-api-error="_onSingleAvailError">
        </t-activity-single-avail-api>

        <t-sessionstorage
            id="sessionStore"
            key="Activitie_Option_Data"
            api-url-format="[[apiUrlFormat]]"
            on-t-sessionstorage-load-success="_onSessionLoad">
        </t-sessionstorage>
    </template>

    <script>
        (function () {

            'use strict'

            Polymer({

                is: 't-activity-option-list-page',

                behaviors: [
                    TravelNxt.Behaviors.PageBehavior,
                    TravelNxt.Behaviors.ActivityPageBehavior
                ],

                properties: {

                    /*
                     * <p>This property holds the value of currency</p>
                     */
                    itinerary: {
                        type: Object,
                        notify: true
                    },

                    /**
                     * Stores possible values of collapse icons.
                     */
                    collapseIcon: {
                        type: Object,
                        value: function() {
                            return {
                                expand: 'icons:expand-more',
                                collapse: 'icons:expand-less'
                            };
                        }
                    }
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                observers: [
                    '_visibleChange(visible)',
                    '_pageLoad(authToken, itineraryId, apiBaseUrl)'
                ],

                /*
                 * <p>observer function for page `visible` property</p>
                */
                _visibleChange: function (visible) {
                    if (visible && (!this.itineraryId || !this.authToken || !this.searchId || !this.apiBaseUrl)) {
                        this.fire('go-to-search');
                    }
                },

                /*
                 * <p>Event handler method called when `t-car-search-api-error` event is fired</p>
                 */
                _pageLoad: function (authToken, itineraryId, apiBaseUrl) {
                    if (!itineraryId || !authToken || !this.searchId || !apiBaseUrl) {
                        return;
                    }

                    this.$.singleAvailApi.getActivity({
                        searchId: this.searchId,
                        itineraryId: this.itineraryId
                    });

                },

                _onSingleAvailSuccess: function (e) {
                    if (!e.detail.inventory) {
                        this.$.fareDetails.error = true;
                        throw Error('failed to add itinerary in the cart!');
                    }

                    this.itinerary = e.detail.inventory;
                },

                _onSingleAvailError: function (e) {
                    
                },

                _onOptionSelect: function (e) {
                    if (e.detail) {
                        this.$.sessionStore.value = e.detail;
                        this.$.sessionStore.save();
                        this.fire('option-select', e.detail);
                    }
                },

                _toggleInfo: function() {
                    this.$.collapseInfo.toggle();
                    var collapseIconInfo = this.$.collapseIconInfo;
                    collapseIconInfo.icon   = collapseIconInfo.icon === 'icons:expand-more'
                                        ? 'icons:expand-less'
                                        : 'icons:expand-more';
                }

            });
        })();                
    </script>
</dom-module>
